# План анализа важности признаков для CNN+LSTM модели

## Обзор подхода

Начнем с простого подхода на основе attention weights из LSTM, затем постепенно расширим до других методов анализа важности признаков.

## Этапы реализации

### Этап 1: Базовый анализ на основе attention weights

#### 1.1 Модификация модели для извлечения attention weights
- Изменить класс `ImprovedStockPredictor` в `stock_predictor_hi.py`
- Добавить метод для извлечения attention weights по признакам
- Сохранить attention weights для каждого временного шага и признака

#### 1.2 Создание базового анализатора
```python
class AttentionFeatureAnalyzer:
    def __init__(self, model, feature_names):
        self.model = model
        self.feature_names = feature_names

    def extract_attention_weights(self, X_data):
        # Извлечение attention weights из модели
        pass

    def calculate_feature_importance(self, attention_weights):
        # Агрегация attention weights по признакам
        pass

    def visualize_importance(self, importance_scores):
        # Визуализация важности признаков в процентах
        pass
```

### Этап 2: Расширенные методы анализа

#### 2.1 Gradient-based анализ
- Использование градиентов выходного слоя относительно входных признаков
- Интегрированная градиентная (Integrated Gradients) методика
- SmoothGrad для уменьшения шума

#### 2.2 Permutation Importance
- Перемешивание значений отдельных признаков
- Оценка влияния на метрику Directional Accuracy
- Статистическая значимость изменений

#### 2.3 SHAP значения для временных рядов
- Адаптация SHAP для временных последовательностей
- Временные SHAP значения для анализа динамики важности

### Этап 3: Комплексный анализ и селекция

#### 3.1 Комбинирование методов
- Взвешенное комбинирование результатов разных методов
- Доверительные интервалы для оценок важности
- Стабильность оценок across different time periods

#### 3.2 Автоматическая селекция признаков
- Пороговые значения для отсечения неважных признаков
- Иерархическая кластеризация признаков
- Динамическая адаптация порогов в зависимости от рыночных условий

## Текущие признаки в модели (20 признаков)

### Базовые признаки:
1. **High** - Максимальная цена дня
2. **Volume** - Объем торгов

### Технические индикаторы:
3. **Returns** - Доходность
4. **EMA_10** - 10-дневная экспоненциальная скользящая средняя
5. **EMA_50** - 50-дневная экспоненциальная скользящая средняя
6. **Volatility** - Волатильность
7. **Volume_EMA** - 20-дневная экспоненциальная скользящая среднего объема
8. **RSI** - Индекс относительной силы
9. **MACD** - MACD гистограмма
10. **BB_Position** - Позиция внутри Bollinger Bands

### Производные признаки:
11. **High_Low_Pct** - Отношение high/low
12. **Price_Change** - Изменение цены
13. **Volume_Change** - Изменение объема
14. **Momentum** - 10-дневный моментум
15. **MA_Ratio** - Отношение SMA_20 к SMA_200

### Адаптивные признаки:
16. **Adaptive_Volatility** - Адаптивная волатильность
17. **Trend_Strength** - Сила тренда
18. **Price_Strength** - Относительная сила цены
19. **Price_to_VWAP** - Отношение цены к VWAP
20. **Volatility_Momentum** - Моментум волатильности

## Ожидаемые результаты

### Гипотезы о важности признаков:
- **Наиболее важные**: Returns, Volatility, RSI, MACD (базовые технические индикаторы)
- **Средней важности**: EMA_10, EMA_50, BB_Position, Trend_Strength
- **Менее важные**: High_Low_Pct, Volume_Change, Price_to_VWAP

### Целевые метрики сокращения:
- Сократить количество признаков с 20 до 8-12 наиболее важных
- Сохранить или улучшить Directional Accuracy
- Уменьшить время обучения на 20-30%
- Увеличить интерпретируемость модели

## План визуализации

### 1. Визуализация важности признаков
- Горизонтальная столбчатая диаграмма с процентами
- Тепловая карта важности признаков по времени
- Динамика важности признаков на разных рыночных режимах

### 2. Сравнительный анализ
- До/после сокращения признаков
- Сравнение разных методов анализа
- Стабильность оценок во времени

## Следующие шаги

1. **Модифицировать существующую модель** для извлечения attention weights
2. **Создать базовый анализатор** на основе attention
3. **Провести первичный анализ** на обученных данных
4. **Визуализировать результаты** в процентах
5. **Расширить методы** анализа по необходимости
6. **Протестировать сокращенную модель** с отобранными признаками

## Критерии успеха

- **Количественные**: Directional Accuracy не ниже исходной модели
- **Качественные**: Улучшенная интерпретируемость, сокращенное время обучения
- **Стабильность**: Важность признаков стабильна across different time periods
